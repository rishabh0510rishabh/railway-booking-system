{% extends 'base.html' %}

{% block content %}
<div class="card bg-light p-4">
  <h1 class="display-6 mb-3">Book Ticket</h1>
  <h5 class="mb-4 text-muted">Train: {{ train.train_name }} ({{ train.source }} to {{ train.destination }})</h5>
  
  <form id="bookingForm" action="{{ url_for('submit_booking') }}" method="post">
    <input type="hidden" name="train_id" value="{{ train.id }}">
    
    <!-- Saved Passengers Dropdown -->
    {% if saved_passengers %}
    <div class="mb-3">
      <label for="saved_passenger" class="form-label">Or select from saved passengers:</label>
      <select class="form-select" id="saved_passenger">
        <option value="">-- Select a passenger --</option>
        {% for passenger in saved_passengers %}
          <option value="{{ passenger.name }},{{ passenger.age }},{{ passenger.berth_preference or '' }}">{{ passenger.name }} ({{ passenger.age }} years old){% if passenger.berth_preference %} - {{ passenger.berth_preference }}{% endif %}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}

    <div class="mb-3">
      <label for="passenger_name" class="form-label">Passenger Name:</label>
      <input type="text" class="form-control" id="passenger_name" name="passenger_name" 
             required aria-required="true" maxlength="100" 
             pattern="[A-Za-z\s]+" title="Please enter a valid name (letters and spaces only)">
    </div>
    
    <div class="mb-3">
      <label for="passenger_age" class="form-label">Age:</label>
      <input type="number" class="form-control" id="passenger_age" name="passenger_age" 
             min="1" max="120" required aria-required="true">
    </div>

    <!-- Add this Seat Class Dropdown -->
    <div class="mb-3">
      <label for="seat_class" class="form-label">Seat Class:</label>
      <select class="form-select" id="seat_class" name="seat_class">
        <option value="Sleeper">Sleeper</option>
        <option value="AC 3 Tier">AC 3 Tier</option>
        <option value="AC 2 Tier">AC 2 Tier</option>
        <option value="AC 1st Class">AC 1st Class</option>
      </select>
    </div>
    
    <!-- Berth Preference Selector -->
    <div class="mb-3">
      <label for="berth_preference" class="form-label">Berth Preference (Optional):</label>
      <select class="form-select" id="berth_preference" name="berth_preference">
        <option value="">No Preference</option>
        <option value="Lower">Lower</option>
        <option value="Middle">Middle</option>
        <option value="Upper">Upper</option>
        <option value="Side Lower">Side Lower</option>
        <option value="Side Upper">Side Upper</option>
      </select>
    </div>

    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" name="save_passenger" id="save_passenger">
      <label class="form-check-label" for="save_passenger">
        Save these passenger details for future use
      </label>
    </div>
    
    <button type="submit" class="btn btn-primary">Confirm Booking</button>
  </form>
</div>

<!-- Payment Confirmation Modal -->
<div class="modal fade" id="fareModal" tabindex="-1" aria-labelledby="fareModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="fareModalLabel">Confirm and Pay</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Passenger:</strong> <span id="modal-passenger-name"></span></p>
        <p><strong>Age:</strong> <span id="modal-passenger-age"></span></p>
        <p><strong>Seat Class:</strong> <span id="modal-seat-class"></span></p>
        <hr>
        <h4>Total Fare: <span id="modal-fare" class="text-success fw-bold"></span></h4>
        <div class="alert alert-info mt-3" role="alert">
          <small>Note: Final status (Confirmed, RAC, WL) will be determined upon booking based on seat availability.</small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="payNowBtn">Pay Now</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const savedPassengerDropdown = document.getElementById('saved_passenger');
    const passengerNameInput = document.getElementById('passenger_name');
    const passengerAgeInput = document.getElementById('passenger_age');
    const seatClassInput = document.getElementById('seat_class');
    const berthPreferenceInput = document.getElementById('berth_preference');
    
    // Payment Modal Elements
    const bookingForm = document.getElementById('bookingForm');
    const fareModal = new bootstrap.Modal(document.getElementById('fareModal'));
    const modalPassengerName = document.getElementById('modal-passenger-name');
    const modalPassengerAge = document.getElementById('modal-passenger-age');
    const modalSeatClass = document.getElementById('modal-seat-class');
    const modalFare = document.getElementById('modal-fare');
    const payNowBtn = document.getElementById('payNowBtn');

    const BASE_FARE = 1000;
    const FARE_MULTIPLIERS = {
        'Sleeper': 1.0,
        'AC 3 Tier': 1.5,
        'AC 2 Tier': 2.0,
        'AC 1st Class': 3.0
    };

    if (savedPassengerDropdown) {
        savedPassengerDropdown.addEventListener('change', function() {
            const selectedValue = this.value;
            if (selectedValue) {
                const [name, age, berth] = selectedValue.split(',');
                passengerNameInput.value = name;
                passengerAgeInput.value = age;
                berthPreferenceInput.value = berth;
            } else {
                passengerNameInput.value = '';
                passengerAgeInput.value = '';
                berthPreferenceInput.value = '';
            }
        });
    }

    // Intercept form submission
    bookingForm.addEventListener('submit', function(event) {
        event.preventDefault(); // Stop the form from submitting immediately

        // Get form values
        const name = passengerNameInput.value;
        const age = passengerAgeInput.value;
        const seatClass = seatClassInput.value;

        // Calculate fare
        const fare = (BASE_FARE * FARE_MULTIPLIERS[seatClass]).toFixed(2);

        // Populate the modal
        modalPassengerName.textContent = name;
        modalPassengerAge.textContent = age;
        modalSeatClass.textContent = seatClass;
        modalFare.textContent = `$${fare}`;

        // Show the modal
        fareModal.show();
    });

    // Handle "Pay Now" button click
    payNowBtn.addEventListener('click', function() {
        fareModal.hide(); // Hide the modal
        bookingForm.submit(); // Submit the form
    });
});
</script>
{% endblock %}
